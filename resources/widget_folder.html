<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Folder</title>
    <link rel="stylesheet" href="fontawesome/css/all.min.css">
    <script src="zod-3.24.4.js"></script>
    <script src="py-browser.js"></script>
    <script src="widget_folder.js"></script>
    <style>
      body { margin: 0; padding: 0; height: 100vh; display: flex;}
      .container { padding:0; margin:0; }
      .tree { padding: 0 0 0 0px; margin: 0; font-size: 0.8em}
      .tree ul { padding: 0 0 0 8px; margin: 0;}
      .tree li { list-style: none; padding: 0; margin:0; white-space: nowrap;}
      .tree .item { padding: 0 3px 1px 3px; margin: 0; cursor: pointer; display: inline-block;}
      .tree .selected {background-color: #bad0e4;}
      .tree .item span { padding: 0; margin: 0}
      .fa-folder { color: #f4a261; margin-right: 5px;}
      .fa-folder-open { color: #f4a261; margin-right: 5px;}
      .fa-file { color: #2a9d8f; margin-right: 5px;}
      .fa-file-code { color: #2a9d8f; margin-right: 5px;}
    </style>
    <script>
        Pb.onLoad(() => {
          send_list_directory({path: null, is_root: true});
        });
        Pb.addCallbacks({
          appendData: appendData
        });


        function appendData(jres) {
          const res = FolderRes.parse(jres);
          let parent_node = document.querySelector("#file-tree");

          if (res.is_root) {
            parent_node.innerHTML = "";
          } else {
            parent_node = document.querySelector("li[data-path='" + encodeURIComponent(res.path) + "']");
          }
          const ul = document.createElement("ul");
          parent_node.appendChild(ul);
          
          for (const item of res.items) {
            const li = document.createElement("li");
            if (item.is_folder) {
              li.dataset.is_folder = "true";
              li.dataset.expanded = "false";
              li.dataset.path = encodeURIComponent(item.path);
              const div = document.createElement("div");
              div.classList.add("item");
              div.innerHTML = `<i class="fa-solid fa-folder"></i><span>${item.name}</span>`;
              if (res.is_root) {
                div.classList.add("selected");
              }
              // li.innerHTML = `<div class="item"><i class="fa-solid fa-folder"></i><span>${item.name}</span></div>`;
              div.addEventListener("click", function(event) {
                event.stopPropagation();
                document.querySelectorAll(".tree li div").forEach(el => {
                  el.classList.remove("selected");
                });
                div.classList.add("selected")
                isExpanded = li.dataset.expanded === "true";
                li.dataset.expanded = !isExpanded;
                if (isExpanded) {
                  li.querySelectorAll("ul").forEach(ul => ul.remove());
                } else {
                  send_list_directory({path: item.path, is_root: false});
                }
              });
              li.appendChild(div);
            } else {
              li.dataset.path = encodeURIComponent(item.path);
              const div = document.createElement("div");
              div.classList.add("item");
              div.innerHTML = `<div class="item"><i class="fa-solid fa-file-code"></i><span>${item.name}</span><div>`;
              div.addEventListener("click", function(event) {
                event.stopPropagation();
                document.querySelectorAll(".tree li div").forEach(el => {
                  el.classList.remove("selected");
                });
                div.classList.add("selected")
                send_open_file({path: item.path});
              });
              li.appendChild(div);

            }
            ul.appendChild(li);
          }
        }


        window.addEventListener("keydown", function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            document.querySelector(".selected").click();
          } else if(event.key === "ArrowDown") {
            event.preventDefault();
            const arr = Array.from(document.querySelectorAll("li>div"));
            const idx = arr.indexOf(document.querySelector("li>div.selected"));
            const next_idx = Math.min(idx+1, arr.length-1);
            if(idx != next_idx){
              arr[idx].classList.remove("selected");
              arr[next_idx].classList.add("selected");
              arr[next_idx].focus();
              arr[next_idx].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
            }
          } else if(event.key === "ArrowUp") {
            event.preventDefault();
            const arr = Array.from(document.querySelectorAll("li>div"));
            const idx = arr.indexOf(document.querySelector("li>div.selected"));
            const prev_idx = Math.max(idx-1, 0);
            if(idx != prev_idx){
              arr[idx].classList.remove("selected");
              arr[prev_idx].classList.add("selected");
              arr[prev_idx].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
            }
          }
        });
    </script>
  </head>

  <body>
  <div class="container">
    <div id="file-tree" class="tree">
      <!--
      <ul class="tree">
        <li class="folder">
          <i class="fa-solid fa-folder"></i><span>Folder 1</span>
          <ul>
            <li>
              <i class="fa-solid fa-folder"></i><span>Folder 2</span>
              <ul>
                <li><i class="fa-solid fa-file-code"></i><span>File 1</span></li>
                <li><i class="fa-solid fa-file-code"></i><span>File 2</span></li>
              </ul>
            </li>
            <li><i class="fa-solid fa-file-code"></i><span>File 1</span></li>
            <li><i class="fa-solid fa-file-code"></i><span>File 2</span></li>
          </ul>
        </li>
      </ul>
      -->
    </div>
  </div>
  </body>
</html>