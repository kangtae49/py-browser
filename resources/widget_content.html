<!doctype html>
<html lang="en">

<head>
  <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Folder</title>
  <link rel="stylesheet" href="fontawesome/css/all.min.css">
  <script src="zod-3.24.4.js"></script>
  <script src="py-browser.js"></script>
  <script src="widget_content.js"></script>

  <style>
    body { margin: 0; padding: 0; height: 100vh; }
    .container { padding: 0; margin: 0; font-size: 0.8em }
    .top-bar { position: fixed; top: 0px; padding-top: 10px; width: 100%; background-color: white; }
    .slider-container { width: 100%; height: 25px; }
    .slider { width: 100%; height: 2px; }
    .ext-container { display: flex; justify-content: space-between; }
    .ext-container .ext-sub { display: flex; }
    .ext-container .ext-sub .ext { padding: 0 2px 0 2px; cursor: pointer;}
    .ext-container .ext-sub .ext[class*="on"] i { color: #2a9d8f; }
    .ext-container .ext-sub .ext i { color: #d4c5ba; }    
    .gallery { display: flex; flex-wrap: wrap; gap: 0px; padding: 75px 5px 0 5px; }
    .gallery .media { width: 20%; display: flex; padding: 0 0px 0 1px;}
    .gallery .media:hover { background-color: #bad0e4; cursor: pointer;}
    .gallery .media .icon { flex: 0 0 16px;}
    .gallery .media .file { flex: 1}
    .gallery .media * { width: 100%; height: 100%; object-fit: scale-down; /* object-fit: contain; */ }
    .gallery .media .file { width: 100%; height: 100%; overflow: hidden; text-overflow: ellipsis; }
    .fileheader { padding: 2px 5px 2px 5px; background-color: #f0f0f0; font-weight: bold;  }
    .filelist { padding: 75px 5px 0 5px; }
    .file-table { display: flex; flex-direction: column;  font-family: sans-serif; }
    .file-header, .file-row { display: flex; }
    .file-row:hover {background-color: #bad0e4;}
    .file-row .i-file {cursor: pointer;}
    .cell.cur-dir {cursor: pointer; display: inline-block;}
    .cell.cur-dir .dir-all {display: inline-block;}
    .cell.cur-dir .dir-part {display: inline-block; cursor: pointer;}
    .cell.cur-dir .dir-part:hover { background-color: #bad0e4;}
    .dir-browser {display: inline-block; cursor:pointer; color: #1e3050;}
    .cell { padding: 0; box-sizing: border-box; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
    .cell.file { flex: 1; text-align: left; }
    .cell.browser { flex: 0 0 16px; text-align: center; cursor:pointer; color: #1e3050;}
    .cell.size { flex: 0 0 80px; text-align: right;}
    .cell.ext { flex: 0 0 50px; text-align: center;}
    .cell.date { flex: 0 0 120px; text-align: right;}
    .fa-folder { color: #f4a261; margin-right: 5px; }
    .fa-folder-open { color: #f4a261; margin-right: 5px; }
    .fa-folder-plus { color: #f4a261; margin-right: 5px; }
    .fa-file { color: #2a9d8f; margin-right: 5px; }
    .fa-file-code { color: #2a9d8f; margin-right: 5px; }
    .fa-images { color: #2a9d8f; margin-right: 5px; }
    .fa-video { color: #2a9d8f; margin-right: 5px; }
    .fa-volume-high { color: #2a9d8f; margin-right: 5px; }
    .fa-ellipsis { color: #2a9d8f; margin-right: 5px; }
    .fa-list { color: #2a9d8f;}
    .fa-table-cells { color: #2a9d8f; }
  </style>
  <script>
    let g_state = null;

    let g_res = [];
    let g_date_formatter = null;
    
    Pb.addListener((params) => {
      g_date_formatter = getDateFormatter();
      const jres = JSON.parse(params);
      const res = BaseMsg.parse(jres);
      window[res.action.toLowerCase()](params);
    });

    window.on_load = (params) => {
      const jres = JSON.parse(params);
      console.log("on_load");
      const res = OnLoadRes.parse(jres);
      g_state = res.state;

      send_list_directory({ path: res.state.path, depth: 1 });

      document.querySelector(".layout-list").addEventListener("click", click_layout_list);
      document.querySelector(".layout-gallery").addEventListener("click", click_layout_gallery);
      document.querySelector('.slider').addEventListener('input', change_slider);

      
    }

    window.list_directory = (params) => {
      const jres = JSON.parse(params);
      const res = FolderRes.parse(jres);
      console.log("page_no: " + res.page_no);
      if (res.page_no == 0) {
        g_res = new Array(Math.ceil(res.item.tot/res.page_size)).fill(null); 
      }
      g_res[res.page_no] = res;

      if (g_res.some((x) => x == null)){
        return;
      }
      if (g_state.gallery_type == GalleryType.enum.LAYOUT_LIST) {
        list_directory_of_list_type();
      } else if(g_state.gallery_type == GalleryType.enum.LAYOUT_GALLERY) {
        list_directory_of_gallery_type();
      }
    }


    window.set_state = (params) => {
      const jres = JSON.parse(params);
      const res = SetStateRes.parse(jres);
      console.log(`set_state: ${res.key}=${res.value}`);
      if (res.key == StateKey.enum.PATH) {
        g_state.path = res.value;
      } else if (res.key == StateKey.enum.GALLERY_TYPE) {
        g_state.gallery_type = res.value;
      } else if (res.key == StateKey.enum.GALLERY_TYPE) {
        g_state.slider_val = res.value;
      }
    }
    
    window.open_path = (params) => {
      console.log("open_path");
      const jres = JSON.parse(params);
      const res = OpenPathRes.parse(jres);
      send_list_directory({ path: res.path, depth: 1 });
    }

    const click_path = (event) => {
      window.getSelection().removeAllRanges();
      const dataset = event.currentTarget.closest(".data").dataset;
      send_list_directory({ path: dataset.path});
      send_set_state({key: StateKey.enum.PATH, value: dataset.path});
    }

    const click_path_application = (event) => {
      window.getSelection().removeAllRanges();
      const dataset = event.currentTarget.closest(".data").dataset;
      send_open_path({ path: dataset.path, open_path_type: OpenPathType.enum.APPLICATION });
    }

    const click_path_browser = (event) => {
      console.log("click_path_browser");
      window.getSelection().removeAllRanges();
      const dataset = event.currentTarget.closest('.data').dataset;
      send_open_path({ path: dataset.path, open_path_type: OpenPathType.enum.BROWSER });
    }

    const click_layout_list = (event) => {
      console.log("click .layout-list");
      if (g_state.gallery_type != GalleryType.enum.LAYOUT_LIST) {
        send_set_state({key: StateKey.enum.GALLERY_TYPE, value: GalleryType.enum.LAYOUT_LIST});
        list_directory_of_list_type();
      }
    };
    
    const click_layout_gallery = (event) => {
      console.log("click .layout-gallery");
      if (g_state.gallery_type != GalleryType.enum.LAYOUT_GALLERY) {
        send_set_state({key: StateKey.enum.GALLERY_TYPE, value: GalleryType.enum.LAYOUT_GALLERY});
        list_directory_of_gallery_type();
      }
    };

    const click_cur_dir_part = (event) => {
      console.log('click_cur_dir_part');
      const dataset = event.currentTarget.closest('.dir-part').dataset;
      const dir_sub = dataset.dir_sub;
      const root_path = dataset.path.split("/")[0] + "/";
      send_list_directory({path: dir_sub, depth: 1});
      send_list_directory({path: root_path, select_path: dir_sub, depth: 0, receiver_id: WidgetId.enum.WIDGET_FOLDER});
    }

    const click_cur_dir = (event) => {
      const dataset = event.currentTarget.closest(".cur-dir").dataset;
      const root_path = dataset.path.split("/")[0] + "/";
      send_list_directory({path: root_path, select_path: root_path, depth: 0, receiver_id: WidgetId.enum.WIDGET_FOLDER});
    }

    const copy_gallery_filename = (event) => {
      const selectedText = window.getSelection().toString();
      const modifiedText = selectedText.replace(/\u200B/g, '');
      const clipboardData = event.clipboardData || window.clipboardData;
      clipboardData.setData('text/plain', modifiedText);
      event.preventDefault();
    }

    const change_slider = (event) => {
      console.log("change_slider")
      if (g_state.slider_val != event.target.value){
        document.querySelectorAll('.gallery .media').forEach(function (element) {
          element.style.width = event.target.value + '%';
        })

        document.querySelectorAll('.file-cell').forEach(function (element) {
          element.style.flex = value;
        })
        send_set_state({ key: StateKey.enum.SLIDER_VAL, value: event.target.value});
      }
    }

    const draw_layout_icon = (gallery_type) => {
      if(gallery_type == GalleryType.enum.LAYOUT_LIST) {
        document.querySelector(".layout-list").classList.add("on");
        document.querySelector(".layout-gallery").classList.remove("on");
      } else {
        document.querySelector(".layout-list").classList.remove("on");
        document.querySelector(".layout-gallery").classList.add("on");
      }
    }

    const show_layout = (gallery_type) => {
      if (gallery_type == GalleryType.enum.LAYOUT_LIST) {
        document.querySelector(".filelist").style.display = "";
        document.querySelector(".fileheader").style.display = "";
        document.querySelector(".slider-container").style.display = "none";
        document.querySelector(".gallery").style.display = "none";

      } else if(gallery_type == GalleryType.enum.LAYOUT_GALLERY) {
        document.querySelector(".filelist").style.display = "none";
        document.querySelector(".fileheader").style.display = "none";
        document.querySelector(".slider-container").style.display = "";
        document.querySelector(".gallery").style.display = "";
      }

    }

    const show_top = () => {
      const res = g_res[0];
      const cur_dir = document.querySelector(".cur-dir");
      cur_dir.dataset.path = res.path;
      
      const cur_dir_icon = cur_dir.querySelector("i");
      const cur_dir_browser = cur_dir.querySelector(".dir-browser");
      cur_dir_browser.addEventListener("click", click_path_browser);

      const cur_dir_all = document.querySelector(".cur-dir .dir-all");
      const arr_dir = res.path.split("/").filter((x) => x);
      cur_dir_all.innerHTML = "";
      for(i=0; i<arr_dir.length; i++) {
        let dir_sub = arr_dir.slice(0, i+1).join("/");
        if (!dir_sub.endsWith("/")){
          dir_sub += "/"; 
        }
        const div_part = document.createElement("div");
        div_part.classList.add("dir-part");
        div_part.dataset.dir_sub = dir_sub;
        div_part.dataset.path = res.path;
        div_part.innerHTML = arr_dir[i];
        div_part.addEventListener("click", click_cur_dir_part);
        cur_dir_all.appendChild(div_part);
        cur_dir_all.append("/");
      }
      cur_dir_icon.addEventListener("click", click_cur_dir);

    }

    const list_directory_of_list_type = () => {
      console.log("list_directory_of_list_type");
      draw_layout_icon(GalleryType.enum.LAYOUT_LIST);
      show_layout(GalleryType.enum.LAYOUT_LIST);
      show_top();
      const arrRes = g_res;
      for (const res of g_res) {
        const div_file_table = document.querySelector(".filelist .file-table");
        if (res.page_no == 0) {
          div_file_table.innerHTML = "";
        }
        const frag = document.createDocumentFragment();
        for (const item of res.item.items) {
          let icon = "fa-file";
          if (item.is_dir && item.tot > 0){
            icon = "fa-folder-plus";
          } else if (item.is_dir && item.tot == 0) {
            icon = "fa-folder";
          } else {
            icon = "fa-file";
          }
          const div_row = document.createElement("div");
          frag.appendChild(div_row);
          div_row.classList.add("file-row", "data");
          div_row.dataset.path = item.path;
          div_row.dataset.is_dir = item.is_dir;
          div_row.innerHTML = `
            <div class="cell file">
              <span class="i-file">
                <span class="icon"><i class="fa-solid ${icon}"></i></span>
                <span class="filename"></span>
              </span>
            </div>
            <div class="cell browser"><i class="fa-solid fa-globe"></i></div>
            <div class="cell size"></div>
            <div class="cell ext">${item.ext}</div>
            <div class="cell date">${toDate(item.mtime)}</div>
          `
          const div_i_file = div_row.querySelector(".i-file");
          const div_icon = div_row.querySelector(".icon");
          const div_filename = div_row.querySelector(".filename");
          const div_size = div_row.querySelector(".cell.size");
          const div_browser = div_row.querySelector(".cell.browser");
          div_size.innerHTML = formatFileSize(item.size);
          div_size.title = item.size;
          div_filename.innerHTML = item.name;
          div_i_file.title = item.name;
          if (item.is_dir) {
            div_icon.addEventListener("click", click_path);
          } else {
            div_icon.addEventListener("dblclick", click_path_application);
          } 
          
          div_filename.addEventListener("dblclick", click_path_application);
          div_browser.addEventListener("click", click_path_browser);
        }
        div_file_table.appendChild(frag);
      }
      const slider = document.querySelector('.slider');
      slider.dispatchEvent(new Event('input', { bubbles: true }));

    }

    const list_directory_of_gallery_type = () => {
      console.log("list_directory_of_gallery_type");
      draw_layout_icon(GalleryType.enum.LAYOUT_GALLERY);
      show_layout(GalleryType.enum.LAYOUT_GALLERY);
      show_top();
      const arrRes = g_res;
      const frag = document.createDocumentFragment();
      for (const res of g_res) {
        const div_gallery = document.querySelector(".gallery");
        if (res.page_no == 0) {
          div_gallery.innerHTML = "";
        }
        for (const item of res.item.items) {
          let icon = "fa-file";
          if (item.is_dir && item.tot > 0){
            icon = "fa-folder-plus";
          } else if (item.is_dir && item.tot == 0) {
            icon = "fa-folder";
          } else {
            icon = "fa-file";
          }
  
          const div_media = document.createElement("div");
          frag.appendChild(div_media);
          div_media.classList.add("media", "data");
          div_media.title = item.name;
          div_media.dataset.is_dir = item.is_dir;
          div_media.dataset.path = item.path;
          if (item.mime.startsWith("video/")) {
            div_media.innerHTML = `
              <video controls>
                <source src="" type="${item.mime}"  />
              </video>
            `;
            div_media.querySelector("source").src = item.path;
          } else if(item.mime.startsWith("audio/")) {
            div_media.innerHTML = `
              <audio controls>
                <source src="" type="${item.mime}"  />
              </audio>
            `;
            div_media.querySelector("source").src = item.path;
          } else if(item.mime.startsWith("image/")) {
            div_media.innerHTML = `
              <img src="" />
            `;
            div_media.querySelector("img").src = item.path;
            div_media.addEventListener("dblclick", click_path_browser);
          } else if(item.is_dir) {
            div_media.innerHTML = `
              <div class="icon"><i class="fa-solid ${icon}"></i></div>
              <div class="file"></div>
            `;
            div_media.querySelector(".file").innerHTML = change_filename(item.name);
            div_media.querySelector(".icon").addEventListener("click", click_path);
            div_media.querySelector(".file").addEventListener("dblclick", click_path_application);
            div_media.querySelector(".file").addEventListener('copy', copy_gallery_filename);
          } else {
            div_media.innerHTML = `
              <div class="icon"><i class="fa-solid ${icon}"></i></div>
              <div class="file"></div>
            `;
            div_media.querySelector(".file").innerHTML = change_filename(item.name);
            div_media.querySelector(".icon").addEventListener("click", click_path_application);
            div_media.querySelector(".file").addEventListener("dblclick", click_path_application);
            div_media.querySelector(".file").addEventListener('copy', copy_gallery_filename);
          }
        }
        div_gallery.appendChild(frag);
      }
      const slider = document.querySelector('.slider');
      slider.dispatchEvent(new Event('input', { bubbles: true }));
    }

    const change_filename = (name) => {
      return name.replace(/(.{5})(?=.)/g, '$1\u200B');
    } 

    const formatFileSize = (bytes) => {
      if (bytes === 0) return '0KB';
      const kb = Math.floor(bytes / 1024);
      return kb.toLocaleString('en-US') + 'KB';
    }

    const getDateFormatter = () => {
      const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const formatter = new Intl.DateTimeFormat('ko-KR', {
        timeZone: timeZone,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
      return formatter;
    } 

    const toDate = (t) => {
      const date = new Date(t * 1000);
      let formatted = g_date_formatter.format(date);
      formatted = formatted.replace(/\s+/g, "").split(".");
      return formatted.slice(0, 3).join("-") + " " + formatted.slice(-1)[0]
    }

  </script>
</head>

<body>
  <div class="container">
    <div class="top-bar">
      <div class="ext-container">
        <div class="ext-sub">
          <!--
          <div class="ext"><i class="fa-solid fa-folder"></i></div>
          <div class="ext"><i class="fa-solid fa-file"></i></div>
          <div class="ext"><i class="fa-solid fa-images"></i></div>
          <div class="ext"><i class="fa-solid fa-video"></i></div>
          <div class="ext"><i class="fa-solid fa-volume-high"></i></div>
          <div class="ext"><i class="fa-solid fa-ellipsis"></i></div>
          -->
        </div>
        <div class="ext-sub">
          <div class="ext layout-list"><i class="fa-solid fa-list"></i></div>
          <div class="ext layout-gallery"><i class="fa-solid fa-table-cells"></i></i></div>
        </div>
      </div>
      <div class="cur-path">
        <div class="cell cur-dir data"><i class="fa-solid fa-folder"></i>
          <div class="dir-all">
          </div>
          <div class="dir-browser"><i class="fa-solid fa-globe"></i></div>
        </div>
      </div>
      <div>
        <div class="fileheader">
          <div class="file-header">
            <div class="cell file">name</div>
            <div class="cell browser"></div>
            <div class="cell size">size</div>
            <div class="cell ext">ext</div>
            <div class="cell date">date</div>
          </div>
        </div>
      </div>

      <div class="slider-container">
        <input class="slider" type="range" id="volume" name="volume" min="0" max="100" value="50">
      </div>

    </div>
    <div class="gallery">
    </div>

    <div class="filelist">
      <div class="file-table"></div>
    </div>

  </div>
</body>


</html>

